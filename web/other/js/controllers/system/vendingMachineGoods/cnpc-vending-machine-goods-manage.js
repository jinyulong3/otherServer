app.controller("cnpcVendingMachineGoodsManage",["$scope","$uibModal","toaster","httpJsonHandle","myConstants","$translate",function($scope,$uibModal,toaster,httpJsonHandle,myConstants,$translate){$scope.selected_customerId=0,$scope.queryVendingMachineGoodsListSendData={sessionId:$scope.app.myData.sessionId,customerId:"",stationId:"",classId:"",limit:"",offset:"",cnpc_flag:1,metaInfo:""},$scope.filterOptions={filterText:"",useExternalFilter:!0},$scope.totalServerItems=0,$scope.pagingOptions={pageSizes:[10,20,30,50,100],pageSize:10,currentPage:1},$scope.host=window.location.host,$scope.columnDefs=[{field:"customerId",displayName:$translate.instant("items.customerManage.customerNo"),width:"*",visible:!1},{field:"customerName",displayName:$translate.instant("items.customerManage.customerName"),width:"*",visible:!1},{field:"stationId",displayName:"站点编号",width:"*",visible:!1},{field:"stationName",displayName:"站点名称",width:"*",visible:!1},{field:"deviceId",displayName:"设备编号",width:"*"},{field:"deviceName",displayName:"设备名称",width:"*"},{field:"channelId",displayName:"货道号",width:"*"},{field:"channelName",displayName:"货道名称",width:"*"},{field:"goodId",displayName:"商品编号",width:"*"},{field:"goodName",displayName:"商品名称",width:"*"},{field:"count",displayName:"个数",width:"*"},{field:"unit",displayName:"单位",width:"*"},{field:"unitPrice",displayName:"单价",width:"*"},{field:"picUrlAddr",displayName:"图片地址",width:"*",visible:!1},{field:"pic",displayName:"图片",width:"100",cellTemplate:'<img src="{{row.entity.picUrlAddr}}" ng-click="imgClick($event)" width="80%" height="80%"  style="display: inline-block;"/>',enableSorting:!1},{field:"time_insert",displayName:"插入时间",width:"*",cellFilter:"filterDateStringSplitMs"}],$scope.imgClick=function($event){var currImg=$($event.target);coverLayer(1);var tempContainer=$("<div class=tempContainer></div>");with(tempContainer){appendTo("body");var windowWidth=$(window).width(),windowHeight=$(window).height(),orignImg=new Image;orignImg.src=currImg.attr("src");var currImgWidth=orignImg.width,currImgHeight=orignImg.height,topHeight,currImgChangeHeight,topHeight;currImgWidth<windowWidth?currImgHeight<windowHeight?(topHeight=(windowHeight-currImgHeight)/2,35<topHeight?(topHeight-=35,css("top",topHeight)):css("top",0),html("<img border=0 src="+currImg.attr("src")+">")):(css("top",0),html("<img border=0 src="+currImg.attr("src")+" height="+windowHeight+">")):(currImgChangeHeight=currImgHeight*windowWidth/currImgWidth,currImgChangeHeight<windowHeight?(topHeight=(windowHeight-currImgChangeHeight)/2,35<topHeight?(topHeight-=35,css("top",topHeight)):css("top",0),html("<img border=0 src="+currImg.attr("src")+" width="+windowWidth+";>")):(css("top",0),html("<img border=0 src="+currImg.attr("src")+" width="+windowWidth+"; height="+windowHeight+">")))}function coverLayer(tag){with($(".over"))1==tag?(css("height",$(document).height()),css("display","block"),css("opacity",1),css("background-color","#FFFFFF"),css("background-color","rgba(0,0,0,0.7)")):css("display","none")}tempContainer.click(function(){$(this).remove(),coverLayer(0)})},$scope.goQuery=function(){var o;void 0!==$scope.info&&"undefined"!=$scope.info.customerId?(console.log($scope.info),console.log($scope.info.stationId),$scope.queryVendingMachineGoodsListSendData.customerId=$scope.info.customerId,void 0!==$scope.info.stationId&&"0"!=$scope.queryVendingMachineGoodsListSendData.stationId?($scope.queryVendingMachineGoodsListSendData.stationId=$scope.info.stationId,void 0!==$scope.info.deviceId&&"0"!=$scope.info.deviceId?void 0!==$scope.cnpc_username&&void 0!==$scope.cnpc_password&&void 0!==$scope.cnpc_ouCode&&""!=$scope.cnpc_username&&""!=$scope.cnpc_password&&""!=$scope.cnpc_ouCode?(console.log($scope.cnpc_username),console.log($scope.cnpc_password),console.log($scope.cnpc_ouCode),$scope.queryVendingMachineGoodsListSendData.metaInfo="",o={username:$scope.cnpc_username,password:$scope.cnpc_password,ouCode:$scope.cnpc_ouCode},$scope.queryVendingMachineGoodsListSendData.metaInfo=JSON.stringify(o),$scope.queryVendingMachineGoodsListSendData.deviceId=$scope.info.deviceId,$scope.getPagedDataAsync($scope.pagingOptions.pageSize,$scope.pagingOptions.currentPage)):toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,"请输入附加信息 登录名 密码 站点编号"):toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,"请选择售卖机")):toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,"请选择站点")):toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,"请选择客户")},$scope.callback=function(o){$scope.myData=o.goodsList,$scope.totalServerItems=o.allCount,toaster.clear()},$scope.setPagingData=function(o,e){$scope.queryVendingMachineGoodsListSendData.offset=1==o?0:(o-1)*e,$scope.queryVendingMachineGoodsListSendData.limit=e,httpJsonHandle.myPost2(myConstants.URL.systemUrl,$scope.queryVendingMachineGoodsListSendData,myConstants.msgIdName.queryVendingMachineGoodsMsgId,myConstants.msgIdName.queryVendingMachineGoodsMsgName,$scope.callback)},$scope.getPagedDataAsync=function(o,e,n){setTimeout(function(){toaster.pop("wait",constantsLang[$scope.app.myData.lang].load.reqData,constantsLang[$scope.app.myData.lang].load.loadingData),$scope.setPagingData(e,o)},100)},$scope.$watch("pagingOptions",function(o,e){o!==e&&$scope.getPagedDataAsync($scope.pagingOptions.pageSize,$scope.pagingOptions.currentPage,$scope.filterOptions.filterText)},!0),$scope.$watch("filterOptions",function(o,e){o!==e&&$scope.getPagedDataAsync($scope.pagingOptions.pageSize,$scope.pagingOptions.currentPage,$scope.filterOptions.filterText)},!0),$scope.gridOptions={i18n:"undefined"!=$scope.app.myData.lang?$scope.app.myData.lang:"zh-cn",data:"myData",enablePaging:!0,showFooter:!0,footerRowHeight:40,totalServerItems:"totalServerItems",pagingOptions:$scope.pagingOptions,enableColumnResizing:!0,rowHeight:42,enableRowSelection:!0,multiSelect:!1,columnDefs:"columnDefs",enableColumnResize:!0,showSelectionCheckbox:!0,filterOptions:$scope.filterOptions},app.controller("btnClickAddGoodsCon",["$scope","$uibModalInstance","info","parentScope",function(n,e,o,t){n.parent=t,n.info=o;var s={sessionId:t.app.myData.sessionId,customerId:o.customerId,stationId:o.stationId,classId:"",limit:2e3,offset:0,cnpc_flag:1,metaInfo:n.info.metaInfo};n.goodsSelChange=function(){console.log(n.info.goodId);for(var o=0;o<n.goodsList.length;o++){var e=n.goodsList[o];if(e.goodId==n.info.goodId)return void(n.info.unitPrice=e.unitPrice)}},n._callback1=function(o){console.log(o),n.goodsList=o.goodsList},httpJsonHandle.myPost2(myConstants.URL.systemUrl,s,myConstants.msgIdName.queryGoodsMsgId,myConstants.msgIdName.queryGoodsMsgName,n._callback1),n.channelRowCount=0;for(var a=n.channelColCount=0;a<n.parent.vendingMachineList.length;a++)n.parent.vendingMachineList[a].deviceId==n.info.deviceId&&(n.channelRowCount=n.parent.vendingMachineList[a].channelRowCount,n.channelColCount=n.parent.vendingMachineList[a].channelColCount);if(0!=n.channelRowCount)if(0!=n.channelColCount){n.channelArr=new Array;for(var i=0,c=["A","B","C","D","E","F","G","H","I","J","K","L","O","P","Q","R","S","T","U","V"],a=0;a<n.channelRowCount;a++){++i;var p=c[a];n.channelArr[a]=new Array;for(var d=0;d<n.channelColCount;d++)n.channelArr[a][d]={id:i,name:p+(d+1)},d!=n.channelColCount-1&&i++}n.selectChannel=function(o,e){n.info.channelId=o,n.info.channelName=e},void 0===t.toQuery_parentClassId?n.info.parentClassId="0":n.info.parentClassId=t.toQuery_parentClassId,n.ok=function(){console.log(n.info),0!=n.info.channelId?void 0!==n.info.goodId&&"0"!=n.info.goodId?(n.info.sessionId=t.app.myData.sessionId,n.info.datatype=myConstants.cmdType.ADD,n.info.classId=n.currentClassId,console.log(n.info),n.callback2=function(o){toaster.clear(),toaster.pop("success",constantsLang[t.app.myData.lang].tips.success,constantsLang[t.app.myData.lang].tips.addSuccess,myConstants.TIMEOUT.timeout1s),e.dismiss(0),t.goQuery()},httpJsonHandle.myPost2(myConstants.URL.systemUrl,n.info,myConstants.msgIdName.manageVendingMachineGoodsMsgId,myConstants.msgIdName.manageVendingMachineGoodsMsgName,n.callback2,e),toaster.pop("wait",constantsLang[t.app.myData.lang].load.reqData,constantsLang[t.app.myData.lang].load.addingData)):toaster.pop("info","提示","请选择商品"):toaster.pop("info","提示","请选择货道")},n.cancel=function(){console.log(n.info),e.dismiss(0)}}else toaster.pop("warning","提示","该设备列数不可为0");else toaster.pop("warning","提示","该设备行数不可为0")}]),$scope.btnClickAddGoods=function(){var o,e=$scope;void 0!==$scope.info&&"undefined"!=$scope.info.customerId?void 0!==$scope.info.stationId&&void 0!==$scope.info.stationId&&"0"!=$scope.info.stationId?void 0!==$scope.info.deviceId&&void 0!==$scope.info.deviceId&&"0"!=$scope.info.stationId?void 0!==$scope.cnpc_username&&void 0!==$scope.cnpc_password&&void 0!==$scope.cnpc_ouCode&&""!=$scope.cnpc_username&&""!=$scope.cnpc_password&&""!=$scope.cnpc_ouCode?(o={username:$scope.cnpc_username,password:$scope.cnpc_password,ouCode:$scope.cnpc_ouCode},$scope.info.metaInfo=JSON.stringify(o),$uibModal.open({templateUrl:"tpl/system/vendingMachineGoods/cnpc/addCnpcVendingMachineGoods.html",controller:"btnClickAddGoodsCon",size:"lg",resolve:{parentScope:e,info:$scope.info}})):toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,"请输入附加信息 登录名 密码 站点编号"):toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,"请选择售卖机"):toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,"请选择站点"):toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,"请选择客户")},app.controller("btnClickEditGoodsCon",["$scope","$uibModalInstance","info","parentScope",function(e,n,o,t){e.info=o,e.submitPic=t.submitPic,e.ok=function(){e.info.sessionId=t.app.myData.sessionId,e.info.datatype=myConstants.cmdType.CHANGE,e.callback3=function(o){toaster.clear(),toaster.pop("success",constantsLang[t.app.myData.lang].tips.success,constantsLang[t.app.myData.lang].tips.editSuccess,myConstants.TIMEOUT.timeout1s),n.dismiss(0),t.goQuery()},httpJsonHandle.myPost2(myConstants.URL.systemUrl,e.info,myConstants.msgIdName.manageVendingMachineGoodsMsgId,myConstants.msgIdName.manageVendingMachineGoodsMsgName,e.callback3,n),toaster.pop("wait",constantsLang[t.app.myData.lang].load.reqData,constantsLang[t.app.myData.lang].load.editingData)},e.cancel=function(){n.dismiss(0)},t.success_submitPic=function(o){e.info.picUrlAddr=o.data.picUrlAddr,console.log(e.info)}}]),$scope.btnClickEditGoods=function(){var o=$scope.gridOptions.$gridScope.selectedItems;console.log(o[0]),0==o.length?toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,constantsLang[$scope.app.myData.lang].tips.noSelectRow):$uibModal.open({templateUrl:"tpl/system/vendingMachineGoods/cnpc/editVendingMachineGoods.html",controller:"btnClickEditGoodsCon",size:"md",resolve:{parentScope:$scope,info:o[0]}})},app.controller("btnClickDelGoodsCon",["$scope","$uibModalInstance","info","parentScope",function(o,e,n,t){o.info=n,o.ok=function(){o.info.sessionId=t.app.myData.sessionId,o.info.datatype=myConstants.cmdType.DEL,o.callback3=function(o){toaster.clear(),toaster.pop("success",constantsLang[t.app.myData.lang].tips.success,constantsLang[t.app.myData.lang].tips.deleteSuccess,myConstants.TIMEOUT.timeout1s),e.dismiss(0),t.goQuery()},httpJsonHandle.myPost2(myConstants.URL.systemUrl,o.info,myConstants.msgIdName.manageVendingMachineGoodsMsgId,myConstants.msgIdName.manageVendingMachineGoodsMsgName,o.callback3,e),toaster.pop("wait",constantsLang[t.app.myData.lang].load.reqData,constantsLang[t.app.myData.lang].load.deletingData)},o.cancel=function(){e.dismiss(0)}}]),$scope.btnClickDelGoods=function(){var o=$scope.gridOptions.$gridScope.selectedItems;0==o.length?toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,constantsLang[$scope.app.myData.lang].tips.noSelectRow):$uibModal.open({templateUrl:"tpl/system/vendingMachineGoods/delVendingMachineGoods.html",controller:"btnClickDelGoodsCon",size:"md",resolve:{parentScope:$scope,info:o[0]}})}}]);