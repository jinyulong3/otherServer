app.controller("goodsManage",["$scope","$uibModal","toaster","httpJsonHandle","myConstants","$translate",function($scope,$uibModal,toaster,httpJsonHandle,myConstants,$translate){$scope.info={},$scope.info.classId0="0",$scope.info.classId1="0",$scope.info.classId2="0",$scope.show1=!1,$scope.show2=!1,$scope.parentClassId="0",$scope.selected_customerId=0,$scope.queryGoodsData={sessionId:$scope.app.myData.sessionId,customerId:"",stationId:"",classId:"",limit:"",offset:""},$scope.filterOptions={filterText:"",useExternalFilter:!0},$scope.totalServerItems=0,$scope.pagingOptions={pageSizes:[10,20,30,50,100],pageSize:10,currentPage:1},$scope.host=window.location.host,$scope.columnDefs=[{field:"customerId",displayName:$translate.instant("items.customerManage.customerNo"),width:"*"},{field:"customerName",displayName:$translate.instant("items.customerManage.customerName"),width:"*"},{field:"stationId",displayName:"站点编号",width:"*"},{field:"stationName",displayName:"站点名称",width:"*"},{field:"classId",displayName:"类别编号",width:"*"},{field:"className",displayName:"类别名称",width:"*"},{field:"goodId",displayName:"商品编号",width:"*"},{field:"goodName",displayName:"商品名称",width:"*"},{field:"unit",displayName:"单位",width:"*"},{field:"unitPrice",displayName:"单价",width:"*"},{field:"manufacturerId",displayName:"厂商编号",width:"*"},{field:"manufacturerName",displayName:"厂商名称",width:"*"},{field:"describe",displayName:"描述",width:"*"},{field:"picUrlAddr",displayName:"图片地址",width:"*",visible:!1},{field:"pic",displayName:"图片",width:"100",cellTemplate:'<img src="http://{{host}}/web{{row.entity.picUrlAddr}}" ng-click="imgClick($event)" width="80%" height="80%"  style="display: inline-block;"/>',enableSorting:!1},{field:"time_insert",displayName:"插入时间",width:"*",cellFilter:"filterDateStringSplitMs"}],$scope.imgClick=function($event){var currImg=$($event.target);coverLayer(1);var tempContainer=$("<div class=tempContainer></div>");with(tempContainer){appendTo("body");var windowWidth=$(window).width(),windowHeight=$(window).height(),orignImg=new Image;orignImg.src=currImg.attr("src");var currImgWidth=orignImg.width,currImgHeight=orignImg.height,topHeight,currImgChangeHeight,topHeight;currImgWidth<windowWidth?currImgHeight<windowHeight?(topHeight=(windowHeight-currImgHeight)/2,35<topHeight?(topHeight-=35,css("top",topHeight)):css("top",0),html("<img border=0 src="+currImg.attr("src")+">")):(css("top",0),html("<img border=0 src="+currImg.attr("src")+" height="+windowHeight+">")):(currImgChangeHeight=currImgHeight*windowWidth/currImgWidth,currImgChangeHeight<windowHeight?(topHeight=(windowHeight-currImgChangeHeight)/2,35<topHeight?(topHeight-=35,css("top",topHeight)):css("top",0),html("<img border=0 src="+currImg.attr("src")+" width="+windowWidth+";>")):(css("top",0),html("<img border=0 src="+currImg.attr("src")+" width="+windowWidth+"; height="+windowHeight+">")))}function coverLayer(tag){with($(".over"))1==tag?(css("height",$(document).height()),css("display","block"),css("opacity",1),css("background-color","#FFFFFF"),css("background-color","rgba(0,0,0,0.7)")):css("display","none")}tempContainer.click(function(){$(this).remove(),coverLayer(0)})},$scope.goQuery=function(){void 0===$scope.info||"undefined"==$scope.info.customerId?toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,"请选择客户"):($scope.queryGoodsData.customerId=$scope.info.customerId,void 0===$scope.info||"undefined"==$scope.info.stationId?$scope.queryGoodsData.stationId="0":$scope.queryGoodsData.stationId=$scope.info.stationId,$scope.queryGoodsData.classId="",$scope.getPagedDataAsync($scope.pagingOptions.pageSize,$scope.pagingOptions.currentPage))},$scope.goQuery_byClass=function(){if(void 0===$scope.info||"undefined"==$scope.info.customerId)toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,"请选择客户");else{if($scope.queryGoodsData.customerId=$scope.info.customerId,void 0===$scope.info||"undefined"==$scope.info.stationId?$scope.queryGoodsData.stationId="0":$scope.queryGoodsData.stationId=$scope.info.stationId,void 0===$scope.currentClassId||"0"==$scope.currentClassId)return void toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,"请选择商品类别");$scope.queryGoodsData.classId=$scope.currentClassId,$scope.getPagedDataAsync($scope.pagingOptions.pageSize,$scope.pagingOptions.currentPage)}},$scope.callback=function(s){$scope.myData=s.goodsList,$scope.totalServerItems=s.allCount,toaster.clear()},$scope.setPagingData=function(s,o){$scope.queryGoodsData.offset=1==s?0:(s-1)*o,$scope.queryGoodsData.limit=o,httpJsonHandle.myPost2(myConstants.URL.systemUrl,$scope.queryGoodsData,myConstants.msgIdName.queryGoodsMsgId,myConstants.msgIdName.queryGoodsMsgName,$scope.callback)},$scope.getPagedDataAsync=function(s,o,t){setTimeout(function(){toaster.pop("wait",constantsLang[$scope.app.myData.lang].load.reqData,constantsLang[$scope.app.myData.lang].load.loadingData),$scope.setPagingData(o,s)},100)},$scope.$watch("pagingOptions",function(s,o){s!==o&&$scope.getPagedDataAsync($scope.pagingOptions.pageSize,$scope.pagingOptions.currentPage,$scope.filterOptions.filterText)},!0),$scope.$watch("filterOptions",function(s,o){s!==o&&$scope.getPagedDataAsync($scope.pagingOptions.pageSize,$scope.pagingOptions.currentPage,$scope.filterOptions.filterText)},!0),$scope.gridOptions={i18n:"undefined"!=$scope.app.myData.lang?$scope.app.myData.lang:"zh-cn",data:"myData",enablePaging:!0,showFooter:!0,footerRowHeight:40,totalServerItems:"totalServerItems",pagingOptions:$scope.pagingOptions,enableColumnResizing:!0,rowHeight:60,enableRowSelection:!0,multiSelect:!1,columnDefs:"columnDefs",enableColumnResize:!0,showSelectionCheckbox:!0,filterOptions:$scope.filterOptions},$scope.clearGoodsClass=function(){},app.controller("btnClickAddGoodsCon",["$scope","$uibModalInstance","info","parentScope",function(o,t,s,e){e.clearGoodsClass(),o.parent=e,o.goodsclassList=e.goodsclassList,o.submitPic=e.submitPic,o.info=s,o.info.classId=e.currentClassId,o.type2="addGoods",void 0===e.toQuery_parentClassId?o.info.parentClassId="0":o.info.parentClassId=e.toQuery_parentClassId,o.ok=function(){void 0!==o.info.classId&&"0"!=o.info.classId?(o.info.sessionId=e.app.myData.sessionId,o.info.datatype=myConstants.cmdType.ADD,o.callback2=function(s){toaster.clear(),toaster.pop("success",constantsLang[e.app.myData.lang].tips.success,constantsLang[e.app.myData.lang].tips.addSuccess,myConstants.TIMEOUT.timeout1s),t.dismiss(0),e.goQuery()},httpJsonHandle.myPost2(myConstants.URL.systemUrl,o.info,myConstants.msgIdName.manageGoodsMsgId,myConstants.msgIdName.manageGoodsMsgName,o.callback2,t),toaster.pop("wait",constantsLang[e.app.myData.lang].load.reqData,constantsLang[e.app.myData.lang].load.addingData)):toaster.pop("info","提示","请选择商品类型")},o.cancel=function(){console.log(o.info),t.dismiss(0)},e.success_submitPic=function(s){o.info.picUrlAddr=s.data.picUrlAddr,console.log(o.info)}}]),$scope.submitPic=function(){var s,o,t=new FormData,e=document.getElementById("addGoods_pic_file").files[0];t.append("file",e),console.log(e),void 0!==e?2e6<e.size?toaster.pop("info","提示","文件大小不得大于2M"):(o=(s=e.name).substr(s.lastIndexOf(".")+1),console.log(o),$scope.isAssetTypeAnImage(o)?(toaster.pop("wait","上传图片","正在上传图片中..."),$.ajax({url:myConstants.URL.uploadPicUrl,data:t,type:"POST",contentType:!1,processData:!1,success:function(s){console.log(s.data.filename),void 0!==$scope.success_submitPic&&$scope.success_submitPic(s),httpJsonHandle.judgeResCode(s),toaster.clear(),toaster.pop("success","成功","上传图片成功",myConstants.TIMEOUT.timeout1s)},error:function(s){toaster.clear(),toaster.pop("fail","失败",s,myConstants.TIMEOUT.timeout1s)}})):toaster.pop("info","提示","只能上传图片类型")):toaster.pop("info","提示","请选择文件")},$scope.isAssetTypeAnImage=function(s){return console.log(s),-1!==["png","jpg","jpeg","bmp","gif","webp","psd","svg","tiff"].indexOf(s.toLowerCase())},$scope.btnClickAddGoods=function(){void 0!==$scope.info&&"undefined"!=$scope.info.customerId?void 0!==$scope.info.stationId&&void 0!==$scope.info.stationId&&"0"!=$scope.info.stationId?void 0!==$scope.info.classId0&&void 0!==$scope.info.classId0&&"0"!=$scope.info.classId0?$uibModal.open({templateUrl:"tpl/system/goods/addGoods.html",controller:"btnClickAddGoodsCon",size:"md",resolve:{parentScope:$scope,info:$scope.info}}):toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,"请选择商品类别"):toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,"请选择站点"):toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,"请选择客户")},app.controller("btnClickEditGoodsCon",["$scope","$uibModalInstance","info","parentScope",function(o,s,t,e){o.info=t,o.submitPic=e.submitPic,o.ok=function(){o.info.sessionId=e.app.myData.sessionId,o.info.datatype=myConstants.cmdType.CHANGE,o.callback3=function(t){toaster.clear(),toaster.pop("success",constantsLang[e.app.myData.lang].tips.success,constantsLang[e.app.myData.lang].tips.editSuccess,myConstants.TIMEOUT.timeout1s),s.dismiss(0),void 0!==e.app.myData.goodsclassList&&e.app.myData.goodsclassList.forEach(function(s,o){s.goodsclassId==t.goodsclassId&&(e.app.myData.goodsclassList[o].goodsclassName=t.goodsclassName)}),e.goQuery()},httpJsonHandle.myPost2(myConstants.URL.systemUrl,o.info,myConstants.msgIdName.manageGoodsMsgId,myConstants.msgIdName.manageGoodsMsgName,o.callback3,s),toaster.pop("wait",constantsLang[e.app.myData.lang].load.reqData,constantsLang[e.app.myData.lang].load.editingData)},o.cancel=function(){s.dismiss(0)},e.success_submitPic=function(s){o.info.picUrlAddr=s.data.picUrlAddr,console.log(o.info)}}]),$scope.btnClickEditGoods=function(){var s=$scope.gridOptions.$gridScope.selectedItems;console.log(s[0]),0==s.length?toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,constantsLang[$scope.app.myData.lang].tips.noSelectRow):$uibModal.open({templateUrl:"tpl/system/goods/editGoods.html",controller:"btnClickEditGoodsCon",size:"md",resolve:{parentScope:$scope,info:s[0]}})},app.controller("btnClickDelGoodsCon",["$scope","$uibModalInstance","info","parentScope",function(s,o,t,e){s.info=t,s.ok=function(){s.info.sessionId=e.app.myData.sessionId,s.info.datatype=myConstants.cmdType.DEL,s.callback3=function(s){toaster.clear(),toaster.pop("success",constantsLang[e.app.myData.lang].tips.success,constantsLang[e.app.myData.lang].tips.deleteSuccess,myConstants.TIMEOUT.timeout1s),o.dismiss(0),e.goQuery()},httpJsonHandle.myPost2(myConstants.URL.systemUrl,s.info,myConstants.msgIdName.manageGoodsMsgId,myConstants.msgIdName.manageGoodsMsgName,s.callback3,o),toaster.pop("wait",constantsLang[e.app.myData.lang].load.reqData,constantsLang[e.app.myData.lang].load.deletingData)},s.cancel=function(){o.dismiss(0)}}]),$scope.btnClickDelGoods=function(){var s=$scope.gridOptions.$gridScope.selectedItems;0==s.length?toaster.pop("info",constantsLang[$scope.app.myData.lang].tips.tip,constantsLang[$scope.app.myData.lang].tips.noSelectRow):$uibModal.open({templateUrl:"tpl/system/goods/delGoods.html",controller:"btnClickDelGoodsCon",size:"md",resolve:{parentScope:$scope,info:s[0]}})}}]);