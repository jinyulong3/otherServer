app.controller("queryPrizeHistory",["$scope","$uibModal","toaster","httpJsonHandle","myConstants","$translate",function(i,e,s,a,n,t){i.myConstants=n,i.flag="queryPrizeHistory",i.queryPrizeHistoryData={sessionId:i.app.myData.sessionId,customerId:"",stationId:"",deviceId:"",prizeDrawId:0,startTime:"2001-01-01",endTime:"2029-02-02",limit:"",offset:""},i.mutiDevicesListAll=[{deviceId:"0",displayName:"全部"}],i.search_select_prizedraw_list=[],i.search_select_prizedraw_listAll=[{prizeDrawId:"0",prizeDrawName:"全部"}],n.getPrizedrawListSendData.sessionId=i.app.myData.sessionId,i.selectPrizedrawChange=function(){i.queryPrizeHistoryData.prizeDrawId=i.selected_prizedrawId,console.log(i.queryPrizeHistoryData)},i.selectMutideviceChange=function(){i.queryPrizeHistoryData.deviceId=i.selected_mutidevicId,console.log(i.queryPrizeHistoryData)},i.payTypes=n.payTypes,i.eventTypes=n.eventTypes,i.filterOptions={filterText:"",useExternalFilter:!0},i.totalServerItems=0,i.pagingOptions={pageSizes:[10,15,25,50,100],pageSize:15,currentPage:1},i.columnDefs=[{field:"stationId",displayName:t.instant("items.stationManage.stationId"),width:"*"},{field:"deviceId",displayName:"设备编号",width:"*"},{field:"prizeDrawId",displayName:"抽奖项目编号",width:"*"},{field:"prizeDrawName",displayName:"抽奖项目名称",width:"150"},{field:"goodId",displayName:"商品编号",width:"*"},{field:"exchangeNo",displayName:"兑奖码",width:"*"},{field:"goodName",displayName:"商品名称",width:"*"},{field:"unit",displayName:"单位",width:"50"},{field:"unitPrice",displayName:"单价",width:"50",cellFilter:"filterMoney"},{field:"prizeId",displayName:"奖品编号",width:"*"},{field:"prizeTime",displayName:"中奖时间",width:"150",cellFilter:"filterDateStringSplitMs"},{field:"exchangeResult",displayName:"是否兑奖",width:"*",cellFilter:"filterExchangeResult"},{field:"isEmpty",displayName:"是否空奖",width:"*",cellFilter:"filterPrizeGoodsIsEmpty"},{field:"transId",displayName:"交易编号",width:"*"}],i.callback=function(e){i.myData=e.prizeHistoryList,i.totalServerItems=e.allCount,s.clear()},i.setPagingData=function(e,t){i.queryPrizeHistoryData.offset=1==e?0:(e-1)*t,i.queryPrizeHistoryData.limit=t,a.myPost2(n.URL.systemUrl,i.queryPrizeHistoryData,n.msgIdName.queryPrizeHistoryMsgId,n.msgIdName.queryPrizeHistoryMsgName,i.callback)},i.getPagedDataAsync=function(e,t,a){setTimeout(function(){s.pop("wait",constantsLang[i.app.myData.lang].load.reqData,constantsLang[i.app.myData.lang].load.loadingData),i.setPagingData(t,e)},100)},i.$watch("pagingOptions",function(e,t){e!==t&&i.getPagedDataAsync(i.pagingOptions.pageSize,i.pagingOptions.currentPage,i.filterOptions.filterText)},!0),i.$watch("filterOptions",function(e,t){e!==t&&i.getPagedDataAsync(i.pagingOptions.pageSize,i.pagingOptions.currentPage,i.filterOptions.filterText)},!0),i.gridOptions={i18n:"undefined"!=i.app.myData.lang?i.app.myData.lang:"zh-cn",data:"myData",enablePaging:!0,showFooter:!0,footerRowHeight:40,totalServerItems:"totalServerItems",pagingOptions:i.pagingOptions,enableColumnResizing:!0,rowHeight:28,enableRowSelection:!0,multiSelect:!1,columnDefs:"columnDefs",enableColumnResize:!0,showSelectionCheckbox:!0,noUnselect:!0,filterOptions:i.filterOptions},i.exchangeResultFlag_list=[{id:0,name:"全部"},{id:1,name:"已兑奖"},{id:2,name:"未兑奖"}],i.isEmptyFlag_list=[{id:0,name:"全部"},{id:1,name:"非空奖"},{id:2,name:"空奖"}],i.goQuery=function(){var e,t;void 0!==i.info&&"undefined"!=i.info.customerId?(i.queryPrizeHistoryData.customerId=i.info.customerId,void 0!==i.info.stationId&&"0"!=i.queryPrizeHistoryData.stationId?(i.queryPrizeHistoryData.stationId=i.info.stationId,i.queryPrizeHistoryData.customerId=n.getPrizedrawListSendData.customerId,i.queryPrizeHistoryData.stationId=n.getPrizedrawListSendData.stationId,i.startDate=$("#startDate").val(),i.stopDate=$("#stopDate").val(),e="2019-01-01",t="2100-01-01",""!=i.startDate&&(e=i.startDate),""!=i.stopDate&&(t=i.stopDate),i.queryPrizeHistoryData.startTime=e,i.queryPrizeHistoryData.stopTime=t,console.log(i.queryPrizeHistoryData),i.getPagedDataAsync(i.pagingOptions.pageSize,1,i.filterOptions.filterText)):s.pop("info",constantsLang[i.app.myData.lang].tips.tip,"请选择站点")):s.pop("info",constantsLang[i.app.myData.lang].tips.tip,"请选择客户")},i.exchangePrizeData={sessionId:i.app.myData.sessionId,customerId:"",stationId:"",prizeDrawId:0,flag:0,exchangeNo:"",goodId:""},i.btnClickExchangePrize=function(){var e=i.gridOptions.$gridScope.selectedItems;if(console.log(e[0]),0==e.length)s.pop("info",constantsLang[i.app.myData.lang].tips.tip,constantsLang[i.app.myData.lang].tips.noSelectRow);else{var t=JSON.parse(JSON.stringify(e[0]));if(0!=t.exchangeResult)return void s.pop("info",constantsLang[i.app.myData.lang].tips.tip,"该奖品不是未兑奖状态");t.sessionId=i.app.myData.sessionId,t.flag=1;a.myPost2(n.URL.systemUrl,t,n.msgIdName.exchangePrizeMsgId,n.msgIdName.exchangePrizeMsgName,function(e){console.log(e),s.clear(),s.pop("success",constantsLang[i.app.myData.lang].tips.success,"已兑奖",n.TIMEOUT.timeout1s),i.getPagedDataAsync(i.pagingOptions.pageSize,i.pagingOptions.currentPage,i.filterOptions.filterText)},null),s.pop("wait",constantsLang[i.app.myData.lang].load.reqData,"正在兑奖处理中...")}},i.btnClickNoExchangePrize=function(){var e=i.gridOptions.$gridScope.selectedItems;if(console.log(e[0]),0==e.length)s.pop("info",constantsLang[i.app.myData.lang].tips.tip,constantsLang[i.app.myData.lang].tips.noSelectRow);else{var t=JSON.parse(JSON.stringify(e[0]));if(0==t.exchangeResult)return void s.pop("info",constantsLang[i.app.myData.lang].tips.tip,"该奖品不是已兑奖状态");t.sessionId=i.app.myData.sessionId,t.flag=2;a.myPost2(n.URL.systemUrl,t,n.msgIdName.exchangePrizeMsgId,n.msgIdName.exchangePrizeMsgName,function(e){console.log(e),s.clear(),s.pop("success",constantsLang[i.app.myData.lang].tips.success,"已取消兑奖",n.TIMEOUT.timeout1s),i.getPagedDataAsync(i.pagingOptions.pageSize,i.pagingOptions.currentPage,i.filterOptions.filterText)},null),s.pop("wait",constantsLang[i.app.myData.lang].load.reqData,"正在取消兑奖处理中...")}}}]);